<%= form_for @survey_answer,
             :html => {:class => 'survey-answer-picker'} do |f| %>
  <dl>
    <dt><%= f.label :assignment_id, 'For' %></dt>
    <dd>
      <%= f.select :assignment_id, SurveyAnswer.assignments_for_user(current_user).
                                                map { |a| [a.name, a.id] } %>
    </dd>
		<span id="survey-assignment-ajax-indicator"></span>
  </dl>  
<% end %>
<%= observe_field 'survey_answer_assignment_id',
      :url => new_survey_answer_path, :method => :get, :frequency => 0.5,
      :before => update_page { |p|
        p.replace_html 'survey-assignment-ajax-indicator', ajax_spinner_image_tag
      },
      :with => "'survey_answer[assignment_id]=' + encodeURIComponent(value)" %>


<% if @survey_answer.assignment %>
<%= remote_form_for @survey_answer,
      :html => {:class => 'survey-answer-form'},
      :before => update_page { |p|            
        p.replace_html 'survey-answer-ajax-indicator', ajax_spinner_image_tag
      } do |f| %>	
  <%= f.error_messages %>
  <%= f.hidden_field :assignment_id %>  

	<% last_target_user = nil %>
	<dl>
	<%= f.fields_for :answers do |a| %>
	
	<% if last_target_user != a.object.target_user %>
	<% last_target_user = a.object.target_user %>
	</dl>
	<h3>
	 	<%= user_image_tag last_target_user %>				
	  <%= last_target_user.display_name_for current_user %>
	</h3>
	<dl>
	<% end %>
	
	<dt>
		<%= a.hidden_field :question_id %>		
		<% if last_target_user %>
      <%= a.hidden_field :target_user_id %>
		<% end %>
    <% question = a.object.question %>
    <%= question.human_string %>
	</dt>		
	<dd>
		<% if question.scaled? %>
		  <%= question.scale_min_label %>
			<% question.scale_min.upto(question.scale_max) do |scale_index| %>
			  <%= a.radio_button :number, scale_index.to_f %>
			<% end %>
			<%= question.scale_max_label %>
		<% else %>
    	<%= a.text_field :number, :size => 8 %>
    <% end %>
	</dd>

  <% if question.allows_comments? %>
	  <dt>
      <%= question.human_string %> - comments
    </dt>
    <dd><%= a.text_area :comment, :rows => 5 %></dd>
  <% end %>

  <% end %>
	</dl>
	
	<p class="privacy-policy">
		Only you and <%= Course.main.number %> Staff can see this.
	</p>
  <span id="survey-answer-ajax-indicator">
    <%= f.submit "Submit" %>
	</span>
<% end %>
<% end %>
