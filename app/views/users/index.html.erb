<h2>Site Users</h2>

<table>
  <tfoot>
    <tr>
      <th><%= pluralize @users.length, 'user' %></th>
      <th>
        <%= pluralize @users.select { |u| u.email_credential.verified? }.length,
                      'verified e-mails' %>
      </th>
    </tr>
  </tfoot>
  <tbody>
    <% @users.sort_by { |u| [u.admin? ? 0 : 1, u.name] }.each do |user| %>
      <tr>
        <td><%= link_to user.name, user %></td>
        <td>
          <% if user.email_credential.verified? %>
            <%= valid_icon_tag %>
          <% else %>
            <%= invalid_icon_tag %>
          <% end %>
          <%= user.email %>
        </td>
        <td>
          <% if user.admin? %>
            <%= role_icon_tag :staff %> staff
          <% else %>
            <%= role_icon_tag :student %> student
          <% end %>
        </td>
        <td>
        <% unless user.admin? %>
          <%= link_to impersonate_user_path(user), method: :post,
                      class: 'button' do %>
            <%= search_icon_tag %> Impersonate
          <% end %>
        <% end %>
        </td>
        <td>
          <%= link_to user, confirm: "Completely wipe #{user.email}'s data?",
                      method: :delete, class: 'button' do %>
            <%= destroy_icon_tag %> Remove
          <% end %>
        </td>
        <td>
          <% if user.admin? %>
            <%= link_to set_admin_user_path(user, :to => false),
                        method: :put, class: 'button' do %>
              <%= role_icon_tag :student %> Student
            <% end %>
          <% elsif user.email_credential.verified? %>
            <%= link_to set_admin_user_path(user, :to => true),
                        method: :put, class: 'button' do %>
              <%= role_icon_tag :staff %> Staff
            <% end %>
          <% else %>
            <%= link_to confirm_email_user_path(user), method: :put,
                        class: 'button' do %>
              <%= valid_icon_tag %> Confirm E-mail
            <% end %>
          <% end %>
        </td>
        <td>
          <% user.registrations.each do |registration| %>
            <%= registration.recitation_section %>
	    <%= best_in_place registration, :recitation_section, :type => :select,
                    :collection => @leaders.each_with_index.map { |l, i| [i, l.name()] } %>
	    <%= best_in_place registration, :recitation_section, :type => :select,
                    :collection => @recitations.each_with_index.map { |l, i| [i, l.leader_id().to_s + ":" + l.time()] } %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
